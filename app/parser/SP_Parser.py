import random
import cianparser
import time
import requests
from bs4 import BeautifulSoup

from cianparser.constants import METRO_STATIONS


proxies = [
    '188.114.98.233:80',
    '172.67.181.197:80',
    '45.12.30.203:80',
    '23.227.38.243:80',
    '172.67.204.236:80',
    '172.64.148.199:80',
    '141.101.120.64:80',
    '141.101.123.245:80',
    '141.193.213.21:80',
    '188.114.97.139:80',
    '63.141.128.50:80',
    '45.131.208.65:80',
    '173.245.49.174:80',
    '69.84.182.55:80',
    '172.67.167.37:80',
    '172.67.142.245:80',
    '5.182.34.154:80',
    '188.114.99.133:80',
    '172.67.254.241:80',
    '172.67.70.152:80',
    '185.162.229.141:80',
    '185.162.228.120:80', '185.162.231.47:80', '173.245.49.89:80',
    '185.162.230.125:80', '185.162.229.135:80', '172.67.172.178:80',
    '172.67.187.229:80', '172.67.188.24:80', '172.67.185.149:80',
    '172.67.185.176:80', '172.64.200.2:80', '141.101.121.73:80',
    '23.227.39.93:80', '66.235.200.218:80', '213.33.126.130:80',
    '172.67.18.108:80', '173.245.49.175:80', '45.131.7.94:80',
    '185.18.250.106:80', '188.114.98.233:80', '141.193.213.11:80',
    '172.67.156.241:80', '188.114.98.233:80',
    '172.67.137.73:80', '188.114.98.233:80', '141.193.213.10:80',
    '188.114.96.203:80', '188.114.96.104:80', '188.114.99.1:80',
    '188.114.99.85:80', '188.114.99.127:80', '185.162.230.216:80',
    '185.162.231.28:80', '185.162.229.225:80', '185.162.230.130:80',
    '45.12.31.132:80', '172.67.223.255:80', '172.67.181.249:80',
    '172.67.231.3:80', '141.101.121.14:80', '141.101.121.161:80',
    '45.131.5.63:80', '66.235.200.102:80', '188.114.98.233:80',
    '172.67.181.197:80', '45.12.30.203:80', '23.227.38.243:80',
    '172.67.204.236:80', '172.64.148.199:80', '141.101.120.64:80',
    '141.101.123.245:80', '141.193.213.21:80', '188.114.97.139:80',
    '63.141.128.50:80', '45.131.208.65:80', '173.245.49.174:80',
    '69.84.182.55:80', '172.67.167.37:80', '172.67.142.245:80',
    '5.182.34.154:80', '188.114.99.133:80', '172.67.254.241:80',
    '172.67.70.152:80', '185.162.229.141:80', '185.162.228.120:80',
    '185.162.231.47:80', '173.245.49.89:80', '185.162.230.125:80',
    '185.162.229.135:80', '172.67.172.178:80', '172.67.187.229:80',
    '172.67.188.24:80', '172.67.185.149:80', '172.67.185.176:80',
    '172.64.200.2:80', '141.101.121.73:80', '23.227.39.93:80',
    '66.235.200.218:80', '213.33.126.130:80', '172.67.18.108:80',
    '173.245.49.175:80', '45.131.7.94:80', '185.18.250.106:80',
    '188.114.98.233:80', '141.193.213.11:80', '172.67.156.241:80',
    '188.114.98.233:80', '172.67.137.73:80', '188.114.98.233:80',
    '141.193.213.10:80', '188.114.96.203:80', '188.114.96.104:80',
    '188.114.99.1:80', '188.114.99.85:80', '188.114.99.127:80',
    '185.162.230.216:80', '185.162.231.28:80', '185.162.229.225:80',
    '185.162.230.130:80', '45.12.31.132:80', '172.67.223.255:80',
    '172.67.181.249:80', '172.67.231.3:80', '141.101.121.14:80',
    '141.101.121.161:80', '45.131.5.63:80', '66.235.200.102:80',
    '188.114.98.233:80', '172.67.181.197:80', '45.12.30.203:80',
    '23.227.38.243:80', '172.67.204.236:80', '172.64.148.199:80',
    '141.101.120.64:80', '141.101.123.245:80', '141.193.213.21:80',
    '188.114.97.139:80', '63.141.128.50:80', '45.131.208.65:80',
    '173.245.49.174:80', '69.84.182.55:80', '172.67.167.37:80',
    '172.67.142.245:80', '5.182.34.154:80', '188.114.99.133:80',
    '172.67.254.241:80', '172.67.70.152:80', '185.162.229.141:80',
    '185.162.228.120:80', '185.162.231.47:80', '173.245.49.89:80',
    '185.162.230.125:80', '185.162.229.135:80', '172.67.172.178:80',
    '172.67.187.229:80', '172.67.188.24:80', '172.67.185.149:80',
    '172.67.185.176:80', '172.64.200.2:80', '141.101.121.73:80',
    '23.227.39.93:80', '66.235.200.218:80', '213.33.126.130:80',
    '172.67.18.108:80', '173.245.49.175:80', '45.131.7.94:80',
    '185.18.250.106:80', '188.114.98.233:80', '141.193.213.11:80',
    '172.67.156.241:80', '188.114.98.233:80', '172.67.137.73:80',
    '188.114.98.233:80', '141.193.213.10:80', '188.114.96.203:80',
    '188.114.96.104:80', '188.114.99.1:80', '188.114.99.85:80',
    '188.114.99.127:80', '185.162.230.216:80', '185.162.231.28:80',
    '185.162.229.225:80', '185.162.230.130:80', '45.12.31.132:80',
    '172.67.223.255:80', '172.67.181.249:80', '172.67.231.3:80',
    '141.101.121.14:80', '141.101.121.161:80', '45.131.5.63:80',
    '66.235.200.102:80', '188.114.98.233:80', '172.67.181.197:80',
    '45.12.30.203:80', '23.227.38.243:80', '172.67.204.236:80',
    '172.64.148.199:80', '141.101.120.64:80', '141.101.123.245:80',
    '141.193.213.21:80', '188.114.97.139:80', '63.141.128.50:80',
    '45.131.208.65:80', '173.245.49.174:80', '69.84.182.55:80',
    '172.67.167.37:80', '172.67.142.245:80', '5.182.34.154:80',
    '188.114.99.133:80', '172.67.254.241:80', '172.67.70.152:80',
    '185.162.229.141:80', '185.162.228.120:80', '185.162.231.47:80',
    '173.245.49.89:80', '185.162.230.125:80', '185.162.229.135:80',
    '172.67.172.178:80', '172.67.187.229:80', '172.67.188.24:80',
    '172.67.185.149:80', '172.67.185.176:80', '172.64.200.2:80',
    '141.101.121.73:80', '23.227.39.93:80', '66.235.200.218:80',
    '213.33.126.130:80', '172.67.18.108:80', '173.245.49.175:80',
    '45.131.7.94:80', '185.18.250.106:80', '188.114.98.233:80',
    '141.193.213.11:80', '172.67.156.241:80', '188.114.98.233:80',
    '172.67.137.73:80', '188.114.98.233:80', '141.193.213.10:80',
    '188.114.96.203:80', '188.114.96.104:80', '188.114.99.1:80',
    '188.114.99.85:80', '188.114.99.127:80', '185.162.230.216:80',
    '185.162.231.28:80', '185.162.229.225:80', '185.162.230.130:80',
    '45.12.31.132:80', '172.67.223.255:80', '172.67.181.249:80',
    '172.67.231.3:80', '141.101.121.14:80', '141.101.121.161:80',
    '45.131.5.63:80', '66.235.200.102:80', '188.114.98.233:80',
    '172.67.181.197:80', '45.12.30.203:80', '23.227.38.243:80',
    '172.67.204.236:80', '172.64.148.199:80', '141.101.120.64:80',
    '141.101.123.245:80', '141.193.213.21:80', '188.114.97.139:80',
    '63.141.128.50:80', '45.131.208.65:80', '173.245.49.174:80',
    '69.84.182.55:80', '172.67.167.37:80', '172.67.142.245:80',
    '5.182.34.154:80', '188.114.99.133:80',
    '172.67.254.241:80', '172.67.70.152:80', '185.162.229.141:80',
    '185.162.228.120:80', '185.162.231.47:80', '173.245.49.89:80',
    '185.162.230.125:80', '185.162.229.135:80', '172.67.172.178:80',
    '172.67.187.229:80', '172.67.188.24:80', '172.67.185.149:80',
    '172.67.185.176:80', '172.64.200.2:80', '141.101.121.73:80',
    '23.227.39.93:80', '66.235.200.218:80', '213.33.126.130:80',
    '172.67.18.108:80', '173.245.49.175:80', '45.131.7.94:80',
    '185.18.250.106:80', '188.114.98.233:80', '141.193.213.11:80',
    '172.67.156.241:80', '188.114.98.233:80', '172.67.137.73:80',
    '188.114.98.233:80', '141.193.213.10:80', '188.114.96.203:80',
    '188.114.96.104:80', '188.114.99.1:80', '188.114.99.85:80',
    '188.114.99.127:80', '185.162.230.216:80', '185.162.231.28:80',
    '185.162.229.225:80', '185.162.230.130:80', '45.12.31.132:80',
    '172.67.223.255:80', '172.67.181.249:80', '172.67.231.3:80',
    '141.101.121.14:80', '141.101.121.161:80',
    '45.131.5.63:80',
    '66.235.200.102:80',
    '43.134.33.254:3128',
    '40.76.69.94:8080',
    '85.210.84.11:8080',
    '3.78.143.77:3128',
    '72.10.160.90:1365',
    '160.86.242.23:8080',
    '4.158.61.222:8080',
    '43.134.121.40:3128',
    '43.134.68.153:3128',
    '54.83.185.141:3128',
    '85.210.203.188:8080',
    '4.159.61.189:8080',
    '51.222.161.115:80',
    '20.204.214.79:3129',
    '20.204.212.45:3129',
    '189.240.60.171:9090',
    '67.43.236.19:17293',
    '148.72.165.7:30127',
    '189.240.60.164:9090',
    '43.134.32.184:3128',
    '20.204.214.23:3129',
    '67.43.227.226:30373',
    '34.97.42.111:8561',
    '34.97.46.219:8561',
    '34.97.47.210:8561',
    '148.72.140.24:30127',
    '4.158.55.159:8080',
    '20.26.249.29:8080',
    '195.25.20.155:3128',
    '35.220.254.137:8080',
    '43.133.59.220:3128',
    '15.235.153.57:8089',
    '54.94.26.82:3128',
    '85.210.121.11:8080',
    '20.44.188.17:3129',
    '20.219.176.57:3129',
    '164.52.206.180:80',
    '93.188.82.142:3128',
    '67.43.227.230:4961',
    '103.107.182.16:25512',
    '67.43.228.252:10579',
    '72.10.160.173:29439',
    '34.97.36.34:8561',
    '200.60.145.167:8082',
    '67.43.228.251:3343',
    '199.195.253.14:1080',
    '72.10.160.92:5635',
    '47.252.29.28:11222',
    '106.227.95.142:3129',
    '67.43.236.18:1853',
    '178.48.68.61:18080',
    '47.243.92.199:3128',
    '47.91.29.151:8081',
    '171.245.116.83:5000',
    '198.24.188.138:37100',
    '195.158.16.9:3128',
    '20.204.212.76:3129',
    '20.44.189.184:3129',
    '67.43.227.229:16401',
    '103.56.157.39:8080',
    '5.189.184.6:80',
    '124.6.155.170:3131',
    '103.147.118.240:8080',
    '116.202.121.34:3128',
    '115.74.129.77:1014',
    '24.106.221.230:53281',
    '212.110.188.195:34411',
    '118.70.184.10:31300',
    '192.99.169.19:8450',
    '36.94.13.63:3128',
    '202.180.20.10:55443',
    '52.82.123.144:3128',
    '185.253.32.26:8080',
    '171.245.113.142:5000',
    '180.88.111.187:3128',
    '116.104.134.32:5000',
    '47.89.184.18:3128',
    '115.74.112.248:1001',
    '173.208.173.202:41113',
    '154.236.177.100:1976',
    '8.213.151.128:3128',
    '45.10.53.177:1080',
    '116.101.205.52:5000',
    '116.97.63.32:5000',
    '171.228.139.137:10089',
    '174.138.171.162:36247',
    '174.138.171.163:38400',
    '31.44.7.32:8080',
    '54.37.118.248:8080',
    '38.183.146.189:8181',
    '167.250.222.233:999',
    '138.117.231.131:999',
    '189.201.153.89:999',
    '35.180.89.184:3128',
    '114.130.153.58:58080',
    '172.233.57.42:7777',
    '5.75.201.136:8443',
    '157.231.136.54:8088',
    '38.45.45.60:999',
    '8.211.195.173:9080',
    '117.250.3.58:8080',
    '115.96.208.124:8080',
    '152.67.0.109:80',
    '45.87.68.2:15321',
    '68.178.170.59:80',
    '20.235.104.105:3729',
    '195.201.34.206:80',
    '184.204.135.252:8080',
    '91.222.238.112:80',
    '194.35.119.58:8888',
    '81.200.149.178:80',
    '212.69.125.33:80',
    '79.173.76.85:60606',
    '188.32.100.60:8080',
    '91.222.238.112:80',
    '213.21.59.134:4153',
    '83.220.46.106:4145',
    '94.231.165.94:60606',
    '188.64.113.104:1080',
    '178.177.54.157:8080',
    '93.157.248.108:88',
    '89.104.108.244:1080',
    '91.241.217.58:9090',
    '185.132.242.212:8083',
    '85.172.5.74:3629',
    '93.171.157.249:8080',
    '31.184.240.132:3128',
    '62.182.204.81:88',
    '109.197.153.146:8888',
    '185.189.101.252:60606',
    '195.98.93.234:1080',
    '109.197.153.25:8888',
    '80.91.21.58:8118',
    '80.240.55.242:3128',
    '109.194.22.61:8080',
    '81.200.149.178:80',
    '109.197.153.121:8888',
    '37.46.135.225:3128',
    '212.164.246.59:8888',
    '176.214.78.230:5678',
    '91.221.177.40:80',
    '31.172.133.253:4153',
    '85.143.254.38:1080',
    '94.28.48.51:3629',
    '147.45.48.233:8080',
    '193.124.9.114:1080',
    '68.178.170.59:80',
    '20.235.104.105:3729',
    '195.201.34.206:80'
]

saintp_parser = cianparser.CianParser(location="Санкт-Петербург")


def get_cian_listings_count(url):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.107 Safari/537.36'
    }

    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()  # Проверяем статус код
    except requests.RequestException as e:
        print(f"Ошибка при отправке запроса: {e}")
        return None

    soup = BeautifulSoup(response.content, 'html.parser')

    count_tag = soup.find('h5', class_='_93444fe79c--color_black_100--Ephi7')

    if count_tag:
        count_text = count_tag.text
        count = ''.join(filter(str.isdigit, count_text))
        return int(count)
    else:
        print("Не удалось найти количество объявлений на странице.")
        return None


def parse_flats(deal_type="sale", max_pages=45):
    """
    Парсинг объявлений с сайта Циан по продаже или аренде квартир.
    :param deal_type: Тип сделки - 'sale' для продажи, 'rent_long' для аренды.
    :param max_pages: Максимальное количество страниц для парсинга.
    :return: Словарь всех объявлений, где ключ - это URL объявления.
    """
    all_flats_data = {}
    rooms = [1, 2, 3, 4, 5, 'studio']
    floors = [(i, i + 1) for i in range(1, 23, 2)]
    floors.append((23, 1000))
    stations = [station[0] for station in METRO_STATIONS["Петербургский"]]

    page_limit = 15  # Максимальное количество страниц в одном запросе
    for start_page in range(1, max_pages + 1, page_limit):
        end_page = min(start_page + page_limit - 1, max_pages)

        for station in stations:
            additional_settings = {
                "start_page": start_page,
                "end_page": end_page,
                "metro": "Петербургский",
                "metro_station": station,
                'metro_foot_minute': 15
            }

            url = saintp_parser.get_request_url(deal_type=deal_type, rooms=tuple(rooms),
                                                accommodation_type="flat", additional_settings=additional_settings)
            listings_count = get_cian_listings_count(url)
            if listings_count is None:
                print(f"Не удалось получить количество объявлений для станции {station}. Пропускаем.")
                continue

            print(f"Количество объявлений для станции {station}: {listings_count}")

            if listings_count > 5000:
                for room in rooms:
                    for floor in floors:
                        additional_settings.update({"min_floor": floor[0], "max_floor": floor[1]})
                        parse_flats_for_station(start_page, end_page, station, deal_type, room, additional_settings,
                                                all_flats_data)
            else:
                for room in rooms:
                    parse_flats_for_station(start_page, end_page, station, deal_type, room, additional_settings,
                                            all_flats_data)

    return all_flats_data


def parse_flats_for_station(start_page, end_page, station, deal_type, room, additional_settings, all_flats_data):
    """
    Парсинг квартир для конкретной станции метро и диапазона страниц.
    :param start_page: Начальная страница.
    :param end_page: Конечная страница.
    :param station: Станция метро.
    :param deal_type: Тип сделки ('sale' или 'rent_long').
    :param room: Количество комнат.
    :param additional_settings: Дополнительные параметры для запроса.
    :param all_flats_data: Словарь для сохранения всех данных (ключ - url).
    """
    print(f"Парсинг с {start_page}-й по {end_page}-ю страницы. room: {room}, station: {station}")

    flats = saintp_parser.get_flats(deal_type=deal_type, rooms=room, with_saving_csv=True,
                                    additional_settings=additional_settings)
    print(f"Количество объявлений для страниц {start_page}-{end_page}: {len(flats)}")

    for flat in flats:
        url = flat.get("url")
        if url and url not in all_flats_data:
            all_flats_data[url] = flat

    time.sleep(random.uniform(1, 15))


sale_flats_data = parse_flats(deal_type="sale", max_pages=45)
rent_flats_data = parse_flats(deal_type="rent_long", max_pages=45)

all_flats_data = {**sale_flats_data, **rent_flats_data}
print(len(all_flats_data))
print(all_flats_data)